{% extends "base.html" %} {% block title %}Portfolio - Trading Signals{%
endblock %} {% block head %}
<link
    href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css"
    rel="stylesheet"
/>
<link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/skeleton_animation.css') }}"
/>
<style>
    .portfolio-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }

    .portfolio-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
    }

    .metric-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .metric-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .change-positive {
        color: var(--success-color);
    }

    .change-negative {
        color: var(--danger-color);
    }

    .portfolio-summary-cards .card {
        background: linear-gradient(
            135deg,
            var(--card-bg) 0%,
            rgba(255, 255, 255, 0.05) 100%
        );
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .portfolio-summary-cards .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .stats-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }

    .quick-actions .btn {
        border-radius: 12px;
        padding: 12px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .quick-actions .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .signals-table {
        background: var(--card-bg);
        border-radius: 0.75rem;
        overflow: hidden;
    }

    .table-dark {
        --bs-table-bg: var(--card-bg);
        --bs-table-color: var(--text-primary);
        --bs-table-border-color: var(--border-color);
    }

    .signal-status {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .signal-active {
        background: rgba(16, 185, 129, 0.2);
        color: var(--success-color);
    }

    .signal-closed {
        background: rgba(239, 68, 68, 0.2);
        color: var(--danger-color);
    }

    .welcome-header {
        background: linear-gradient(
            135deg,
            #667eea 0%,
            #764ba2 100%
        ) !important;
        color: white !important;
        border: none !important;
        border-radius: 0.75rem !important;
    }

    .signal-pnl-positive {
        color: var(--success-color);
        font-weight: 600;
    }

    .signal-pnl-negative {
        color: var(--danger-color);
        font-weight: 600;
    }

    .project-summary-card {
        border-left: 4px solid var(--primary-color);
        transition: all 0.3s ease;
    }

    .project-summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .project-icon {
        font-size: 1.5rem;
        opacity: 0.7;
    }

    .progress-container {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 120px;
    }

    .progress-container .progress {
        flex: 1;
        border-radius: 10px;
    }

    .progress-text {
        font-size: 0.8rem;
        font-weight: 600;
        min-width: 35px;
    }
</style>
{% endblock %} {% block content %}
<div class="container-fluid">
    <!-- Content Container with relative positioning -->
    <div style="position: relative; min-height: 600px">
        <!-- Portfolio Skeleton Loading -->
        <div id="portfolioSkeleton" class="skeleton-loading">
            <!-- Welcome Header Skeleton -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="skeleton-welcome-header">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center">
                                        <div
                                            class="skeleton-welcome-avatar me-3"
                                        ></div>
                                        <div>
                                            <div
                                                class="skeleton-welcome-title"
                                            ></div>
                                            <div
                                                class="skeleton-welcome-subtitle"
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div
                                        class="d-flex gap-2 justify-content-end"
                                    >
                                        <div class="skeleton-welcome-btn"></div>
                                        <div class="skeleton-welcome-btn"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Cards Skeleton -->
            <div class="row mb-4">
                <div class="col-4">
                    <div class="skeleton skeleton-summary-card"></div>
                    <div class="skeleton skeleton-summary-card"></div>
                    <div class="skeleton skeleton-summary-card"></div>
                </div>
                <div class="col-4">
                    <div
                        class="skeleton skeleton-portfolio-card"
                        style="height: 400px"
                    ></div>
                </div>
                <div class="col-4">
                    <div
                        class="skeleton skeleton-portfolio-card"
                        style="height: 400px"
                    ></div>
                </div>
            </div>

            <!-- Table Rows Skeleton -->
            <div class="row">
                <div class="col-12">
                    <div class="skeleton skeleton-table-row"></div>
                    <div class="skeleton skeleton-table-row"></div>
                    <div class="skeleton skeleton-table-row"></div>
                    <div class="skeleton skeleton-table-row"></div>
                    <div class="skeleton skeleton-table-row"></div>
                </div>
            </div>
        </div>

        <!-- Main Portfolio Content -->
        <div id="portfolioContent">
            <!-- Welcome Section -->
            <div class="row mb-4 content-loading" id="portfolioWelcomeSection">
                <div class="col-12">
                    <div class="card welcome-header">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar-large me-3">
                                            <i
                                                class="fas fa-chart-line fa-3x text-white"
                                            ></i>
                                        </div>
                                        <div>
                                            <h3 class="text-white mb-1">
                                                Portfolio
                                            </h3>
                                            <p class="text-white-50 mb-0">
                                                <i
                                                    class="fas fa-clock me-1"
                                                ></i>
                                                Last updated:
                                                <span id="lastUpdateTime"
                                                    >Just now</span
                                                >
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div
                                        class="d-flex gap-2 justify-content-end"
                                    >
                                        <a
                                            href="/trading-signals"
                                            class="btn btn-outline-light"
                                        >
                                            <i class="fas fa-signal me-1"></i
                                            >All Signals
                                        </a>
                                        <button
                                            class="btn btn-outline-light"
                                            onclick="refreshSignals()"
                                        >
                                            <i class="fas fa-sync me-1"></i
                                            >Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-md-4 mb-4">
                    <div class="mb-3">
                        <div class="card border-0 h-100 project-summary-card">
                            <div class="card-body">
                                <div
                                    class="d-flex justify-content-between align-items-start"
                                >
                                    <div>
                                        <h6 class="text-muted mb-2">
                                            Total Deals
                                        </h6>
                                        <h2
                                            class="text-primary mb-0"
                                            id="totalDeals"
                                        >
                                            {{ deals_stats.total_deals if deals_stats else 0 }}
                                        </h2>
                                    </div>
                                    <div class="project-icon">
                                        <i
                                            class="fas fa-project-diagram text-primary"
                                        ></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="card border-0 h-100 project-summary-card">
                            <div class="card-body">
                                <div
                                    class="d-flex justify-content-between align-items-start"
                                >
                                    <div>
                                        <h6 class="text-muted mb-2">
                                            Active Deals
                                        </h6>
                                        <h2
                                            class="text-info mb-0"
                                            id="activeDeals"
                                        >
                                            {{ deals_stats.active_deals if deals_stats else 0 }}
                                        </h2>
                                    </div>
                                    <div class="project-icon">
                                        <i class="fas fa-tasks text-info"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="card border-0 h-100 project-summary-card">
                            <div class="card-body">
                                <div
                                    class="d-flex justify-content-between align-items-start"
                                >
                                    <div>
                                        <h6 class="text-muted mb-2">
                                            Closed Deals
                                        </h6>
                                        <h2
                                            class="text-success mb-0"
                                            id="closedDeals"
                                        >
                                            {{ deals_stats.closed_deals if deals_stats else 0 }}
                                        </h2>
                                    </div>
                                    <div class="project-icon">
                                        <i
                                            class="fas fa-check-circle text-success"
                                        ></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Symbol Selector and Deal Progress -->
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="mb-0">Deal Progress</h6>
                        </div>
                        <div class="card-body">
                            <!-- Symbol Selector -->
                            <div class="mb-3">
                                <label for="symbolSelector" class="form-label"
                                    >Select Symbol:</label
                                >
                                <select
                                    class="form-select"
                                    id="symbolSelector"
                                    onchange="loadSymbolData()"
                                >
                                    <option value="">Choose a symbol...</option>
                                    {% if deals_stats and deals_stats.symbols %}
                                        {% for symbol in deals_stats.symbols %}
                                        <option value="{{ symbol }}">{{ symbol }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>

                            <!-- Deal Progress Pie Chart -->
                            <div
                                class="chart-container"
                                style="position: relative; height: 250px"
                            >
                                <canvas id="projectProgressChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Symbol Data and Bar Chart -->
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="mb-0">Symbol Analysis</h6>
                        </div>
                        <div class="card-body">
                            <!-- Symbol Data Display -->
                            <div id="symbolDataDisplay" style="display: none">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">CMP</small>
                                        <div class="fw-bold" id="symbolCMP">
                                            --
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">P&L</small>
                                        <div class="fw-bold" id="symbolPL">
                                            --
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <small class="text-muted"
                                            >Investment Value</small
                                        >
                                        <div
                                            class="fw-bold"
                                            id="symbolInvestment"
                                        >
                                            --
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bar Chart -->
                            <div
                                class="chart-container"
                                style="position: relative; height: 250px"
                            >
                                <canvas id="tasksByProjectChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Selected Symbol Details Table -->
            <div class="row" id="symbolDetailsSection" style="display: none">
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                Selected Symbol:
                                <span id="selectedSymbolName">--</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="symbolDealsTable">
                                <!-- Symbol deals will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Global variables for charts
    let progressChart = null;
    let barChart = null;

    // Portfolio data from backend
    const portfolioData = {
        total_deals: {{ deals_stats.total_deals if deals_stats else 0 }},
        active_deals: {{ deals_stats.active_deals if deals_stats else 0 }},
        closed_deals: {{ deals_stats.closed_deals if deals_stats else 0 }},
        status_chart_data: {{ deals_stats.status_chart_data|tojson|safe if deals_stats else '{"labels": [], "data": [], "colors": []}' }},
        symbol_chart_data: {{ deals_stats.symbol_chart_data|tojson|safe if deals_stats else '{"labels": [], "data": [], "colors": []}' }}
    };

    // Load portfolio data on page load
    document.addEventListener("DOMContentLoaded", function () {
        initializeCharts();
        showChartData();
    });

    // Show chart data function
    function showChartData() {
        // Update pie chart with real data
        if (progressChart && portfolioData.status_chart_data) {
            const activeDeals = portfolioData.active_deals || 0;
            const closedDeals = portfolioData.closed_deals || 0;

            // Always show the chart with meaningful data
            if (activeDeals === 0 && closedDeals === 0) {
                progressChart.data.datasets[0].data = [1];
                progressChart.data.labels = ["No Deals Available"];
                progressChart.data.datasets[0].backgroundColor = ["#95a5a6"];
            } else {
                progressChart.data.datasets[0].data = [activeDeals, closedDeals];
                progressChart.data.labels = ["Active Deals", "Closed Deals"];
                progressChart.data.datasets[0].backgroundColor = ["#10B981", "#EF4444"];
            }
            progressChart.update("active");
            
            // Update symbol chart if available
            if (barChart && portfolioData.symbol_chart_data && portfolioData.symbol_chart_data.labels.length > 0) {
                barChart.data.labels = portfolioData.symbol_chart_data.labels;
                barChart.data.datasets[0].data = portfolioData.symbol_chart_data.data;
                barChart.data.datasets[0].backgroundColor = portfolioData.symbol_chart_data.colors || ['#3B82F6'];
                barChart.update("active");
            }
        }
    }

    // Initialize charts function
    function initializeCharts() {
        // Progress Chart (Pie chart for deal status)
        const progressCtx = document.getElementById("projectProgressChart").getContext("2d");
        progressChart = new Chart(progressCtx, {
            type: "doughnut",
            data: {
                labels: ["Active Deals", "Closed Deals"],
                datasets: [
                    {
                        data: [1, 0],
                        backgroundColor: ["#10B981", "#EF4444"],
                        borderWidth: 0,
                        hoverOffset: 4,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: "bottom",
                        labels: { usePointStyle: true, color: "#6b7280" },
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ": " + context.parsed;
                            }
                        }
                    }
                },
                cutout: "60%",
            },
        });

        // Bar Chart (Symbol distribution)
        const barCtx = document.getElementById("tasksByProjectChart").getContext("2d");
        barChart = new Chart(barCtx, {
            type: "bar",
            data: {
                labels: [],
                datasets: [
                    {
                        label: "Deals per Symbol",
                        data: [],
                        backgroundColor: "#3B82F6",
                        borderRadius: 4,
                        maxBarThickness: 40,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1, color: "#6b7280" },
                        grid: { color: "#374151" },
                    },
                    x: {
                        ticks: { color: "#6b7280" },
                        grid: { display: false },
                    },
                },
            },
        });
    }

    // Load symbol-specific data (placeholder function)
    function loadSymbolData() {
        const symbolSelector = document.getElementById("symbolSelector");
        const selectedSymbol = symbolSelector.value;

        if (!selectedSymbol) {
            document.getElementById("symbolDataDisplay").style.display = "none";
            return;
        }

        // Show symbol data display with basic info
        document.getElementById("symbolDataDisplay").style.display = "block";
        document.getElementById("symbolCMP").textContent = "Loading...";
        document.getElementById("symbolPL").textContent = "Loading...";
        document.getElementById("symbolInvestment").textContent = "Loading...";
    }

    // Load symbol-specific data
    async function loadSymbolData() {
        const symbolSelector = document.getElementById("symbolSelector");
        const selectedSymbol = symbolSelector.value;

        if (!selectedSymbol) {
            document.getElementById("symbolDataDisplay").style.display = "none";
            return;
        }

        try {
            const response = await fetch(
                `/api/portfolio/symbol-data/${selectedSymbol}`,
            );
            const result = await response.json();

            if (result.success) {
                const data = result.data;

                // Show symbol data display
                document.getElementById("symbolDataDisplay").style.display =
                    "block";

                // Update symbol data
                document.getElementById("symbolCMP").textContent =
                    `₹${data.cmp}`;

                const plElement = document.getElementById("symbolPL");
                plElement.textContent = `₹${data.profit_loss} (${data.profit_loss_percentage}%)`;
                plElement.className =
                    data.profit_loss >= 0
                        ? "fw-bold text-success"
                        : "fw-bold text-danger";

                document.getElementById("symbolInvestment").textContent =
                    `₹${data.total_investment}`;

                // Show symbol details section and update name
                document.getElementById("symbolDetailsSection").style.display =
                    "block";
                document.getElementById("selectedSymbolName").textContent =
                    selectedSymbol;

                // Create deals table
                const dealsTableHTML = `
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Entry Price</th>
                                    <th>Quantity</th>
                                    <th>Investment</th>
                                    <th>Current Value</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.deals
                                    .map(
                                        (deal) => `
                                    <tr>
                                        <td>${deal.date}</td>
                                        <td>₹${deal.entry_price}</td>
                                        <td>${deal.qty}</td>
                                        <td>₹${deal.investment}</td>
                                        <td>₹${deal.current_value}</td>
                                        <td><span class="badge ${deal.status === "ACTIVE" ? "bg-success" : "bg-secondary"}">${deal.status}</span></td>
                                    </tr>
                                `,
                                    )
                                    .join("")}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById("symbolDealsTable").innerHTML =
                    dealsTableHTML;

                // Update bar chart with symbol data
                if (barChart) {
                    barChart.data.labels = [
                        "Investment",
                        "Current Value",
                        "P&L",
                    ];
                    barChart.data.datasets[0].data = [
                        data.total_investment,
                        data.current_value,
                        Math.abs(data.profit_loss),
                    ];
                    barChart.data.datasets[0].backgroundColor = [
                        "#3498db",
                        "#2ecc71",
                        data.profit_loss >= 0 ? "#2ecc71" : "#e74c3c",
                    ];
                    barChart.update();
                }
            }
        } catch (error) {
            console.error("Error loading symbol data:", error);
        }
    }

    // Initialize charts
    function initializeCharts() {
        // Progress Pie Chart
        const progressCtx = document
            .getElementById("projectProgressChart")
            .getContext("2d");
        progressChart = new Chart(progressCtx, {
            type: "doughnut",
            data: {
                labels: ["Loading..."],
                datasets: [
                    {
                        data: [1], // Initialize with single value to show chart
                        backgroundColor: ["#95a5a6"],
                        borderWidth: 2,
                        borderColor: "#fff",
                        hoverBackgroundColor: ["#7f8c8d"],
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: "50%", // Makes it a proper doughnut chart
                plugins: {
                    legend: {
                        position: "bottom",
                        labels: {
                            padding: 20,
                            font: {
                                size: 12,
                            },
                            color: "#ffffff",
                        },
                    },
                },
                elements: {
                    arc: {
                        borderWidth: 2,
                    },
                },
            },
        });

        // Bar Chart
        const barCtx = document
            .getElementById("tasksByProjectChart")
            .getContext("2d");
        barChart = new Chart(barCtx, {
            type: "bar",
            data: {
                labels: ["Select Symbol"],
                datasets: [
                    {
                        label: "Amount (₹)",
                        data: [0],
                        backgroundColor: ["#95a5a6"],
                        borderWidth: 1,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false,
                    },
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return "₹" + value.toLocaleString();
                            },
                        },
                    },
                },
            },
        });
    }

    // Refresh function
    function refreshSignals() {
        loadPortfolioStats();
        loadSymbolOptions();
        document.getElementById("lastUpdateTime").textContent = "Just now";
    }
</script>
{% endblock %}
