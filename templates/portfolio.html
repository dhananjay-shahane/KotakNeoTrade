{% extends "base.html" %} {% block title %}Portfolio - Trading Signals{%
endblock %} {% block head %}
<link
    href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css"
    rel="stylesheet"
/>
<link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/skeleton_animation.css') }}"
/>
<style>
    .portfolio-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }

    .portfolio-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
    }

    .metric-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .metric-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .change-positive {
        color: var(--success-color);
    }

    .change-negative {
        color: var(--danger-color);
    }

    .portfolio-summary-cards .card {
        background: linear-gradient(
            135deg,
            var(--card-bg) 0%,
            rgba(255, 255, 255, 0.05) 100%
        );
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .portfolio-summary-cards .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .stats-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }

    .quick-actions .btn {
        border-radius: 12px;
        padding: 12px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .quick-actions .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .signals-table {
        background: var(--card-bg);
        border-radius: 0.75rem;
        overflow: hidden;
    }

    .table-dark {
        --bs-table-bg: var(--card-bg);
        --bs-table-color: var(--text-primary);
        --bs-table-border-color: var(--border-color);
    }

    .signal-status {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .signal-active {
        background: rgba(16, 185, 129, 0.2);
        color: var(--success-color);
    }

    .signal-closed {
        background: rgba(239, 68, 68, 0.2);
        color: var(--danger-color);
    }

    .welcome-header {
        background: linear-gradient(
            135deg,
            #667eea 0%,
            #764ba2 100%
        ) !important;
        color: white !important;
        border: none !important;
        border-radius: 0.75rem !important;
    }

    .signal-pnl-positive {
        color: var(--success-color);
        font-weight: 600;
    }

    .signal-pnl-negative {
        color: var(--danger-color);
        font-weight: 600;
    }

    .project-summary-card {
        border-left: 4px solid var(--primary-color);
        transition: all 0.3s ease;
    }

    .project-summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .project-icon {
        font-size: 1.5rem;
        opacity: 0.7;
    }

    .progress-container {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 120px;
    }

    .progress-container .progress {
        flex: 1;
        border-radius: 10px;
    }

    .progress-text {
        font-size: 0.8rem;
        font-weight: 600;
        min-width: 35px;
    }
</style>
{% endblock %} {% block content %}
<div class="container-fluid">
    <!-- Content Container with relative positioning -->
    <div style="position: relative; min-height: 600px">
        <!-- Portfolio Skeleton Loading -->
        <div id="portfolioSkeleton" class="skeleton-loading">
            <!-- Welcome Header Skeleton -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="skeleton-welcome-header">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center">
                                        <div
                                            class="skeleton-welcome-avatar me-3"
                                        ></div>
                                        <div>
                                            <div
                                                class="skeleton-welcome-title"
                                            ></div>
                                            <div
                                                class="skeleton-welcome-subtitle"
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div
                                        class="d-flex gap-2 justify-content-end"
                                    >
                                        <div class="skeleton-welcome-btn"></div>
                                        <div class="skeleton-welcome-btn"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Cards Skeleton -->
            <div class="row mb-4">
                <div class="col-4">
                    <div class="skeleton skeleton-summary-card"></div>
                    <div class="skeleton skeleton-summary-card"></div>
                    <div class="skeleton skeleton-summary-card"></div>
                </div>
                <div class="col-4">
                    <div
                        class="skeleton skeleton-portfolio-card"
                        style="height: 400px"
                    ></div>
                </div>
                <div class="col-4">
                    <div
                        class="skeleton skeleton-portfolio-card"
                        style="height: 400px"
                    ></div>
                </div>
            </div>

            <!-- Table Rows Skeleton -->
            <div class="row">
                <div class="col-12">
                    <div class="skeleton skeleton-table-row"></div>
                    <div class="skeleton skeleton-table-row"></div>
                    <div class="skeleton skeleton-table-row"></div>
                    <div class="skeleton skeleton-table-row"></div>
                    <div class="skeleton skeleton-table-row"></div>
                </div>
            </div>
        </div>

        <!-- Main Portfolio Content -->
        <div id="portfolioContent">
            <!-- Welcome Section -->
            <div class="row mb-4 content-loading" id="portfolioWelcomeSection">
                <div class="col-12">
                    <div class="card welcome-header">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar-large me-3">
                                            <i
                                                class="fas fa-chart-line fa-3x text-white"
                                            ></i>
                                        </div>
                                        <div>
                                            <h3 class="text-white mb-1">
                                                User Portfolio
                                            </h3>
                                            <p class="text-white-50 mb-0">
                                                <i
                                                    class="fas fa-clock me-1"
                                                ></i>
                                                Last updated:
                                                <span id="lastUpdateTime"
                                                    >Just now</span
                                                >
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div
                                        class="d-flex gap-2 justify-content-end"
                                    >
                                        <a
                                            href="/trading-signals"
                                            class="btn btn-outline-light"
                                        >
                                            <i class="fas fa-signal me-1"></i
                                            >All Signals
                                        </a>
                                        <button
                                            class="btn btn-outline-light"
                                            onclick="refreshSignals()"
                                        >
                                            <i class="fas fa-sync me-1"></i
                                            >Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-md-4 mb-4">
                    <div class="mb-3">
                        <div class="card border-0 h-100 project-summary-card">
                            <div class="card-body">
                                <div
                                    class="d-flex justify-content-between align-items-start"
                                >
                                    <div>
                                        <h6 class="text-muted mb-2">
                                            Total Deals
                                        </h6>
                                        <h2
                                            class="text-primary mb-0"
                                            id="totalDeals"
                                        >
                                            0
                                        </h2>
                                    </div>
                                    <div class="project-icon">
                                        <i
                                            class="fas fa-project-diagram text-primary"
                                        ></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="card border-0 h-100 project-summary-card">
                            <div class="card-body">
                                <div
                                    class="d-flex justify-content-between align-items-start"
                                >
                                    <div>
                                        <h6 class="text-muted mb-2">
                                            Active Deals
                                        </h6>
                                        <h2
                                            class="text-success mb-0"
                                            id="activeDeals"
                                        >
                                            0
                                        </h2>
                                    </div>
                                    <div class="project-icon">
                                        <i
                                            class="fas fa-chart-line text-success"
                                        ></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="card border-0 h-100 project-summary-card">
                            <div class="card-body">
                                <div
                                    class="d-flex justify-content-between align-items-start"
                                >
                                    <div>
                                        <h6 class="text-muted mb-2">
                                            Closed Deals
                                        </h6>
                                        <h2
                                            class="text-secondary mb-0"
                                            id="closedDeals"
                                        >
                                            0
                                        </h2>
                                    </div>
                                    <div class="project-icon">
                                        <i
                                            class="fas fa-check-circle text-secondary"
                                        ></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3 d-none">
                        <div class="card border-0 h-100 project-summary-card">
                            <div class="card-body">
                                <div
                                    class="d-flex justify-content-between align-items-start"
                                >
                                    <div>
                                        <h6 class="text-muted mb-2">
                                            Total Investment
                                        </h6>
                                        <h2
                                            class="text-info mb-0"
                                            id="totalInvestment"
                                        >
                                            ₹0
                                        </h2>
                                    </div>
                                    <div class="project-icon">
                                        <i class="fas fa-coins text-info"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3 d-none">
                        <div class="card border-0 h-100 project-summary-card">
                            <div class="card-body">
                                <div
                                    class="d-flex justify-content-between align-items-start"
                                >
                                    <div>
                                        <h6 class="text-muted mb-2">
                                            Profit/Loss
                                        </h6>
                                        <h2 class="mb-0" id="totalPnL">₹0</h2>
                                    </div>
                                    <div class="project-icon">
                                        <i
                                            class="fas fa-chart-line"
                                            id="pnlIcon"
                                        ></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Symbol Selector and Deal Progress -->
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="mb-0">Deals Distribution</h6>
                        </div>
                        <div class="card-body">
                            <!-- Symbol Selector -->
                            <div class="mb-3">
                                <label for="symbolSelector" class="form-label"
                                    >Select Symbol:</label
                                >
                                <select
                                    class="form-select"
                                    id="symbolSelector"
                                    onchange="loadSymbolData()"
                                >
                                    <option value="">Choose a symbol...</option>
                                </select>
                            </div>

                            <!-- Deal Progress Pie Chart -->
                            <div
                                class="chart-container"
                                style="position: relative; height: 250px"
                            >
                                <canvas id="projectProgressChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Symbol Data and Bar Chart -->
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="mb-0">Symbol Analysis</h6>
                        </div>
                        <div class="card-body">
                            <!-- Symbol Data Display -->
                            <div id="symbolDataDisplay" style="display: none">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">CMP</small>
                                        <div class="fw-bold" id="symbolCMP">
                                            --
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">P&L</small>
                                        <div class="fw-bold" id="symbolPL">
                                            --
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <small class="text-muted"
                                            >Investment Value</small
                                        >
                                        <div
                                            class="fw-bold"
                                            id="symbolInvestment"
                                        >
                                            --
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bar Chart -->
                            <div
                                class="chart-container"
                                style="position: relative; height: 250px"
                            >
                                <canvas id="tasksByProjectChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Selected Symbol Details Table -->
            <div class="row" id="symbolDetailsSection" style="display: none">
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                Selected Symbol:
                                <span id="selectedSymbolName">--</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="symbolDealsTable">
                                <!-- Symbol deals will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Global variables for charts
    let progressChart = null;
    let barChart = null;

    // Portfolio data will be loaded from API
    let portfolioData = {
        total_deals: 0,
        active_deals: 0,
        closed_deals: 0,
        status_chart_data: { labels: [], data: [], colors: [] },
        symbol_chart_data: { labels: [], data: [], colors: [] },
    };

    // Load portfolio data on page load
    document.addEventListener("DOMContentLoaded", function () {
        initializeCharts();
        loadPortfolioData();
    });

    // Load portfolio data from user deals API
    async function loadPortfolioData() {
        try {
            console.log("Fetching user deals data...");
            const response = await fetch("/api/user-deals-data");
            console.log("Response status:", response.status);

            const result = await response.json();
            console.log("User deals API response:", result);

            if (result.success && result.data && result.data.length > 0) {
                // Hide skeleton loader and show content
                document.getElementById("portfolioSkeleton").style.display = "none";
                document.getElementById("portfolioContent").style.display = "block";
                
                // Process user deals data
                processUserDealsData(result.data);
                updatePortfolioDisplay();
                updateCharts();
                loadSymbolOptions();
                
                // Auto-select first symbol if available
                if (portfolioData.symbols && portfolioData.symbols.length > 0) {
                    const symbolSelector = document.getElementById("symbolSelector");
                    symbolSelector.value = portfolioData.symbols[0];
                    loadSymbolData(); // Load data for the first symbol
                }
            } else {
                console.log("No deals data available or empty response");
                // Hide skeleton loader
                document.getElementById("portfolioSkeleton").style.display = "none";
                document.getElementById("portfolioContent").style.display = "block";
                showNoDealsMessage();
            }
        } catch (error) {
            console.error("Error loading portfolio data:", error);
            showNoDealsMessage();
        }
    }

    // Process user deals data into portfolio format
    function processUserDealsData(deals) {
        console.log("Processing deals data:", deals);
        
        let totalInvestment = 0;
        let totalCurrentValue = 0;
        let totalPnL = 0;
        let activeDeals = 0;
        let closedDeals = 0;
        let symbols = [];
        let symbolData = {};

        if (!deals || !Array.isArray(deals)) {
            console.warn("Invalid deals data received:", deals);
            deals = [];
        }

        deals.forEach((deal, index) => {
            try {
                const symbol = deal.symbol || 'Unknown';
                const investment = parseFloat(deal.inv) || 0;
                const qty = parseFloat(deal.qty) || 0;
                const cmp = parseFloat(deal.cmp) || 0;
                const currentValue = cmp * qty;
                const pnl = parseFloat(deal.pl) || 0;
                const isActive = deal.status === 'ACTIVE';

                // Only process deals with valid data
                if (symbol !== 'Unknown' && (investment > 0 || qty > 0)) {
                    totalInvestment += investment;
                    totalCurrentValue += currentValue;
                    totalPnL += pnl;

                    if (isActive) {
                        activeDeals++;
                    } else {
                        closedDeals++;
                    }

                    // Track symbols
                    if (!symbols.includes(symbol)) {
                        symbols.push(symbol);
                        symbolData[symbol] = {
                            investment: 0,
                            currentValue: 0,
                            pnl: 0,
                            deals: []
                        };
                    }

                    symbolData[symbol].investment += investment;
                    symbolData[symbol].currentValue += currentValue;
                    symbolData[symbol].pnl += pnl;
                    symbolData[symbol].deals.push(deal);
                }
            } catch (error) {
                console.error(`Error processing deal at index ${index}:`, error, deal);
            }
        });

        portfolioData = {
            total_deals: activeDeals + closedDeals, // Only count valid deals
            active_deals: activeDeals,
            closed_deals: closedDeals,
            total_investment: totalInvestment,
            total_current_value: totalCurrentValue,
            total_pnl: totalPnL,
            symbols: symbols,
            symbol_data: symbolData,
            deals_list: deals
        };
        
        console.log("Processed portfolio data:", portfolioData);
    }

    // Show no deals message
    function showNoDealsMessage() {
        // Hide skeleton loader
        document.getElementById("portfolioSkeleton").style.display = "none";
        
        // Show main content area but with no deals message
        document.getElementById("portfolioContent").style.display = "block";
        
        // Replace the charts row with no deals message
        const chartsRow = document.querySelector('.row.mb-4:nth-child(2)');
        if (chartsRow) {
            chartsRow.innerHTML = `
                <div class="col-12">
                    <div class="card h-100 text-center py-5">
                        <div class="card-body">
                            <i class="fas fa-chart-line fa-4x text-muted mb-4"></i>
                            <h4 class="text-muted mb-3">No Deals Available</h4>
                            <p class="text-muted mb-4">You haven't added any deals yet. Start by adding deals from trading signals.</p>
                            <div class="d-flex gap-2 justify-content-center">
                                <a href="/trading-signals" class="btn btn-primary">
                                    <i class="fas fa-signal me-2"></i>View Trading Signals
                                </a>
                                <a href="/deals" class="btn btn-outline-primary">
                                    <i class="fas fa-plus me-2"></i>Add Deals
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Hide symbol details section
        document.getElementById("symbolDetailsSection").style.display = "none";
    }

    // Update portfolio display with loaded data
    function updatePortfolioDisplay() {
        console.log("Updating portfolio display with data:", portfolioData);

        const totalDeals = portfolioData.total_deals || 0;
        const activeDeals = portfolioData.active_deals || 0;
        const closedDeals = portfolioData.closed_deals || 0;
        const totalInvestment = portfolioData.total_investment || 0;
        const totalPnL = portfolioData.total_pnl || 0;

        console.log("Values:", {
            totalDeals,
            activeDeals,
            closedDeals,
            totalInvestment,
            totalPnL,
        });

        document.getElementById("totalDeals").textContent = totalDeals;
        document.getElementById("activeDeals").textContent = activeDeals;
        document.getElementById("closedDeals").textContent = closedDeals;
        document.getElementById("totalInvestment").textContent =
            `₹${totalInvestment.toLocaleString()}`;

        const pnlElement = document.getElementById("totalPnL");
        const pnlIcon = document.getElementById("pnlIcon");

        pnlElement.textContent = `₹${totalPnL.toLocaleString()}`;

        if (totalPnL >= 0) {
            pnlElement.className = "text-success mb-0";
            pnlIcon.className = "fas fa-chart-line text-success";
        } else {
            pnlElement.className = "text-danger mb-0";
            pnlIcon.className = "fas fa-chart-line text-danger";
        }
    }

    // Update charts with loaded data
    function updateCharts() {
        // Update pie chart with Active vs Closed deals data
        if (progressChart) {
            const activeDeals = portfolioData.active_deals || 0;
            const closedDeals = portfolioData.closed_deals || 0;
            const totalDeals = activeDeals + closedDeals;
            
            if (totalDeals > 0) {
                // Prepare chart data for Active vs Closed deals
                const labels = ["Active Deals", "Closed Deals"];
                const data = [activeDeals, closedDeals];
                const colors = [
                    "#10B981", // Green for Active deals
                    "#6B7280"  // Gray for Closed deals
                ];

                progressChart.data.labels = labels;
                progressChart.data.datasets[0].data = data;
                progressChart.data.datasets[0].backgroundColor = colors;
                progressChart.data.datasets[0].borderColor = "#ffffff";
                progressChart.data.datasets[0].borderWidth = 2;
                progressChart.update("active");
                
                console.log("Pie chart updated with Active vs Closed deals:", {
                    labels,
                    data,
                    colors,
                    totalDeals
                });
            } else {
                // Show "No Data" when there are no deals
                progressChart.data.labels = ["No Deals Available"];
                progressChart.data.datasets[0].data = [1];
                progressChart.data.datasets[0].backgroundColor = ["#95a5a6"];
                progressChart.data.datasets[0].borderColor = "#ffffff";
                progressChart.data.datasets[0].borderWidth = 2;
                progressChart.update("active");
                
                console.log("Pie chart updated with no data message");
            }
        }

        // Update symbol chart with symbol distribution
        if (barChart && portfolioData.symbols && portfolioData.symbols.length > 0) {
            // Create symbol distribution data
            const symbolCounts = {};
            if (portfolioData.deals_list && portfolioData.deals_list.length > 0) {
                portfolioData.deals_list.forEach(deal => {
                    const symbol = deal.symbol;
                    if (symbol) {
                        symbolCounts[symbol] = (symbolCounts[symbol] || 0) + 1;
                    }
                });
            }
            
            const symbolLabels = Object.keys(symbolCounts);
            const symbolData = Object.values(symbolCounts);
            const symbolColors = symbolLabels.map((_, index) => {
                const colors = ["#3B82F6", "#10B981", "#F59E0B", "#EF4444", "#8B5CF6", "#06B6D4"];
                return colors[index % colors.length];
            });
            
            if (symbolLabels.length > 0) {
                barChart.data.labels = symbolLabels;
                barChart.data.datasets[0].data = symbolData;
                barChart.data.datasets[0].backgroundColor = symbolColors;
                barChart.update("active");
                
                console.log("Bar chart updated with symbol distribution:", {
                    labels: symbolLabels,
                    data: symbolData
                });
            } else {
                // Show "No Data" when there are no symbols
                barChart.data.labels = ["No Symbols"];
                barChart.data.datasets[0].data = [1];
                barChart.data.datasets[0].backgroundColor = ["#95a5a6"];
                barChart.update("active");
            }
        }
    }

    // Load symbol options for dropdown
    function loadSymbolOptions() {
        if (portfolioData.symbols && portfolioData.symbols.length > 0) {
            const symbolSelector = document.getElementById("symbolSelector");
            symbolSelector.innerHTML = '<option value="">Choose a symbol...</option>';

            portfolioData.symbols.forEach((symbol) => {
                const option = document.createElement("option");
                option.value = symbol;
                option.textContent = symbol;
                symbolSelector.appendChild(option);
            });
        }
    }

    // Initialize charts function
    function initializeCharts() {
        // Progress Chart (Pie chart for Investment vs P&L)
        const progressCtx = document
            .getElementById("projectProgressChart")
            .getContext("2d");
        progressChart = new Chart(progressCtx, {
            type: "doughnut",
            data: {
                labels: ["Loading..."],
                datasets: [
                    {
                        data: [1],
                        backgroundColor: ["#95a5a6"],
                        borderColor: "#ffffff",
                        borderWidth: 2,
                        hoverOffset: 4,
                        hoverBorderWidth: 3,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: "index",
                },
                plugins: {
                    legend: {
                        position: "bottom",
                        labels: {
                            usePointStyle: true,
                            color: "#ffffff",
                            padding: 15,
                            font: {
                                size: 12,
                            },
                        },
                    },
                    tooltip: {
                        backgroundColor: "rgba(0, 0, 0, 0.8)",
                        titleColor: "#ffffff",
                        bodyColor: "#ffffff",
                        borderColor: "#ffffff",
                        borderWidth: 1,
                        callbacks: {
                            label: function (context) {
                                const label = context.label || "";
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ": " + value + " deals (" + percentage + "%)";
                            },
                        },
                    },
                },
                cutout: "50%",
                animation: {
                    animateRotate: true,
                    animateScale: true,
                },
            },
        });

        // Bar Chart (Symbol distribution)
        const barCtx = document
            .getElementById("tasksByProjectChart")
            .getContext("2d");
        barChart = new Chart(barCtx, {
            type: "bar",
            data: {
                labels: [],
                datasets: [
                    {
                        label: "Deals per Symbol",
                        data: [],
                        backgroundColor: "#3B82F6",
                        borderRadius: 4,
                        maxBarThickness: 40,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1, color: "#6b7280" },
                        grid: { color: "#374151" },
                    },
                    x: {
                        ticks: { color: "#6b7280" },
                        grid: { display: false },
                    },
                },
            },
        });
    }

    // Load symbol-specific data from processed user deals
    async function loadSymbolData() {
        const symbolSelector = document.getElementById("symbolSelector");
        const selectedSymbol = symbolSelector.value;

        if (!selectedSymbol || !portfolioData.symbol_data) {
            document.getElementById("symbolDataDisplay").style.display = "none";
            document.getElementById("symbolDetailsSection").style.display = "none";
            return;
        }

        const symbolData = portfolioData.symbol_data[selectedSymbol];
        if (!symbolData) {
            document.getElementById("symbolDataDisplay").style.display = "none";
            return;
        }

        // Show symbol data display
        document.getElementById("symbolDataDisplay").style.display = "block";

        // Calculate average CMP from deals
        let totalQty = 0;
        let weightedCMP = 0;
        symbolData.deals.forEach(deal => {
            const qty = parseFloat(deal.qty) || 0;
            const cmp = parseFloat(deal.cmp) || 0;
            totalQty += qty;
            weightedCMP += (cmp * qty);
        });
        const avgCMP = totalQty > 0 ? (weightedCMP / totalQty).toFixed(2) : 0;

        // Update symbol data
        document.getElementById("symbolCMP").textContent = `₹${avgCMP}`;

        const plElement = document.getElementById("symbolPL");
        const profitLossPercent = symbolData.investment > 0 ? 
            ((symbolData.pnl / symbolData.investment) * 100).toFixed(2) : 0;
        plElement.textContent = `₹${symbolData.pnl.toFixed(2)} (${profitLossPercent}%)`;
        plElement.className = symbolData.pnl >= 0 ? "fw-bold text-success" : "fw-bold text-danger";

        document.getElementById("symbolInvestment").textContent = `₹${symbolData.investment.toFixed(2)}`;

        // Show symbol details section
        document.getElementById("symbolDetailsSection").style.display = "block";
        document.getElementById("selectedSymbolName").textContent = selectedSymbol;

        // Create deals table
        if (symbolData.deals && symbolData.deals.length > 0) {
            const dealsTableHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Entry Price</th>
                                <th>Quantity</th>
                                <th>Investment</th>
                                <th>Current Value</th>
                                <th>P&L</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${symbolData.deals.map(deal => `
                                <tr>
                                    <td>${deal.date || deal.created_at || "N/A"}</td>
                                    <td>₹${deal.ep || deal.entry_price || "0"}</td>
                                    <td>${deal.qty || "0"}</td>
                                    <td>₹${deal.inv || deal.investment || "0"}</td>
                                    <td>₹${(parseFloat(deal.cmp || 0) * parseFloat(deal.qty || 0)).toFixed(2)}</td>
                                    <td class="${parseFloat(deal.pl || 0) >= 0 ? 'text-success' : 'text-danger'}">₹${deal.pl || "0"}</td>
                                    <td><span class="badge ${deal.status === "ACTIVE" ? "bg-success" : "bg-secondary"}">${deal.status || "Unknown"}</span></td>
                                </tr>
                            `).join("")}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById("symbolDealsTable").innerHTML = dealsTableHTML;
        } else {
            document.getElementById("symbolDealsTable").innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-info-circle mb-2"></i>
                    <p>No deals found for this symbol</p>
                </div>
            `;
        }

        // Update bar chart with symbol data
        if (barChart && symbolData.investment > 0) {
            barChart.data.labels = ["Investment", "Current Value", "P&L"];
            barChart.data.datasets[0].data = [
                symbolData.investment,
                symbolData.currentValue,
                Math.abs(symbolData.pnl)
            ];
            barChart.data.datasets[0].backgroundColor = [
                "#3498db",
                "#2ecc71", 
                symbolData.pnl >= 0 ? "#2ecc71" : "#e74c3c"
            ];
            barChart.update("active");
        }
    }

    

    // Initialize charts
    function initializeCharts() {
        // Progress Pie Chart
        const progressCtx = document
            .getElementById("projectProgressChart")
            .getContext("2d");
        progressChart = new Chart(progressCtx, {
            type: "doughnut",
            data: {
                labels: ["Loading..."],
                datasets: [
                    {
                        data: [1], // Initialize with single value to show chart
                        backgroundColor: ["#95a5a6"],
                        borderWidth: 2,
                        borderColor: "#fff",
                        hoverBackgroundColor: ["#7f8c8d"],
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: "50%", // Makes it a proper doughnut chart
                plugins: {
                    legend: {
                        position: "bottom",
                        labels: {
                            padding: 20,
                            font: {
                                size: 12,
                            },
                            color: "#ffffff",
                        },
                    },
                },
                elements: {
                    arc: {
                        borderWidth: 2,
                    },
                },
            },
        });

        // Bar Chart
        const barCtx = document
            .getElementById("tasksByProjectChart")
            .getContext("2d");
        barChart = new Chart(barCtx, {
            type: "bar",
            data: {
                labels: ["Select Symbol"],
                datasets: [
                    {
                        label: "Amount (₹)",
                        data: [0],
                        backgroundColor: ["#95a5a6"],
                        borderWidth: 1,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false,
                    },
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return "₹" + value.toLocaleString();
                            },
                        },
                    },
                },
            },
        });
    }

    // Refresh function
    function refreshSignals() {
        loadPortfolioData();
        document.getElementById("lastUpdateTime").textContent = "Just now";
    }
</script>
{% endblock %}
