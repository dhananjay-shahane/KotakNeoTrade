
{% extends "base.html" %} 
{% block title %}Portfolio - Kotak Neo Trading{% endblock %} 

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" rel="stylesheet">
<style>
    .portfolio-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }

    .portfolio-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
    }

    .metric-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .metric-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .change-positive {
        color: var(--success-color);
    }

    .change-negative {
        color: var(--danger-color);
    }

    .portfolio-summary-cards .card {
        background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 255, 255, 0.05) 100%);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .portfolio-summary-cards .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .stats-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }

    .quick-actions .btn {
        border-radius: 12px;
        padding: 12px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .quick-actions .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .holdings-table {
        background: var(--card-bg);
        border-radius: 0.75rem;
        overflow: hidden;
    }

    .table-dark {
        --bs-table-bg: var(--card-bg);
        --bs-table-color: var(--text-primary);
        --bs-table-border-color: var(--border-color);
    }

    .performance-indicator {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .performance-positive {
        background: rgba(16, 185, 129, 0.2);
        color: var(--success-color);
    }

    .performance-negative {
        background: rgba(239, 68, 68, 0.2);
        color: var(--danger-color);
    }

    .account-status-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }

    .watchlist-item {
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s ease;
    }

    .watchlist-item:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    .price-movement {
        font-weight: 600;
        display: flex;
        align-items: center;
    }

    .price-up::before {
        content: "▲";
        margin-right: 4px;
        color: var(--success-color);
    }

    .price-down::before {
        content: "▼";
        margin-right: 4px;
        color: var(--danger-color);
    }
</style>
{% endblock %}

{% block content %}
{% if show_kotak_dashboard %}
<!-- Kotak Neo Portfolio Dashboard -->
<div class="container-fluid">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card account-status-card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar-large me-3">
                                    <i class="fas fa-user-circle fa-3x text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-white mb-1">Welcome back, {{ ucc or 'Trader' }}!</h3>
                                    <p class="text-white-50 mb-0">
                                        <i class="fas fa-clock me-1"></i>
                                        Last updated: <span id="lastUpdateTime">Just now</span>
                                    </p>
                                    <p class="text-white-50 mb-0">
                                        <i class="fas fa-mobile-alt me-1"></i>
                                        {{ mobile or 'Not provided' }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                <a href="{{ url_for('kotak_api.positions') }}" class="btn btn-outline-light">
                                    <i class="fas fa-chart-line me-1"></i>Positions
                                </a>
                                <a href="{{ url_for('kotak_api.orders') }}" class="btn btn-outline-light">
                                    <i class="fas fa-list me-1"></i>Orders
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Summary Cards -->
    <div class="row portfolio-summary-cards mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 h-100">
                <div class="card-body text-center">
                    <div class="stats-icon bg-primary text-white mx-auto mb-3">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <h5 class="card-title">Portfolio Value</h5>
                    <div class="metric-value text-primary" id="portfolioValue">₹0.00</div>
                    <div class="metric-label">
                        <span class="change-positive" id="portfolioChange">+₹0.00 (0.00%)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card border-0 h-100">
                <div class="card-body text-center">
                    <div class="stats-icon bg-success text-white mx-auto mb-3">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h5 class="card-title">Today's P&L</h5>
                    <div class="metric-value text-success" id="todayPnl">₹0.00</div>
                    <div class="metric-label">
                        <span class="change-positive" id="todayPnlPercent">+0.00%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card border-0 h-100">
                <div class="card-body text-center">
                    <div class="stats-icon bg-warning text-dark mx-auto mb-3">
                        <i class="fas fa-coins"></i>
                    </div>
                    <h5 class="card-title">Available Margin</h5>
                    <div class="metric-value text-warning" id="availableMargin">₹0.00</div>
                    <div class="metric-label">Available for trading</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card border-0 h-100">
                <div class="card-body text-center">
                    <div class="stats-icon bg-info text-white mx-auto mb-3">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <h5 class="card-title">Active Positions</h5>
                    <div class="metric-value text-info" id="activePositions">0</div>
                    <div class="metric-label">Open positions</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Quick Actions Row -->
    <div class="row mb-4">
        <!-- Portfolio Performance Chart -->
        <div class="col-md-8 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>Portfolio Performance
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" data-period="1D">1D</button>
                        <button class="btn btn-outline-primary" data-period="1W">1W</button>
                        <button class="btn btn-outline-primary" data-period="1M">1M</button>
                        <button class="btn btn-outline-primary" data-period="3M">3M</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions and Watchlist -->
        <div class="col-md-4 mb-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body quick-actions">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('kotak_api.orders') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Place Order
                        </a>
                        <a href="{{ url_for('kotak_api.holdings') }}" class="btn btn-success">
                            <i class="fas fa-eye me-2"></i>View Holdings
                        </a>
                        <a href="{{ url_for('kotak_api.positions') }}" class="btn btn-info">
                            <i class="fas fa-chart-pie me-2"></i>Manage Positions
                        </a>
                        <button class="btn btn-warning" onclick="refreshPortfolio()">
                            <i class="fas fa-sync me-2"></i>Refresh Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Market Watchlist -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Watchlist
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="addToWatchlist()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="card-body p-0" id="watchlistContainer">
                    <div class="watchlist-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>NIFTY 50</strong>
                            <br><small class="text-muted">NSE</small>
                        </div>
                        <div class="text-end">
                            <div class="price-movement price-up">22,150.35</div>
                            <small class="text-success">+1.25%</small>
                        </div>
                    </div>
                    <div class="watchlist-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>BANKNIFTY</strong>
                            <br><small class="text-muted">NSE</small>
                        </div>
                        <div class="text-end">
                            <div class="price-movement price-down">48,920.40</div>
                            <small class="text-danger">-0.85%</small>
                        </div>
                    </div>
                    <div class="watchlist-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>SENSEX</strong>
                            <br><small class="text-muted">BSE</small>
                        </div>
                        <div class="text-end">
                            <div class="price-movement price-up">73,450.20</div>
                            <small class="text-success">+0.65%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Holdings and Recent Transactions -->
    <div class="row">
        <!-- Top Holdings -->
        <div class="col-md-8 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-briefcase me-2"></i>Top Holdings
                    </h5>
                    <a href="{{ url_for('kotak_api.holdings') }}" class="btn btn-sm btn-outline-primary">
                        View All Holdings
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive holdings-table">
                        <table class="table table-dark mb-0" id="holdingsTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Quantity</th>
                                    <th>Avg Price</th>
                                    <th>LTP</th>
                                    <th>P&L</th>
                                    <th>Performance</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <strong>RELIANCE</strong>
                                        <br><small class="text-muted">NSE</small>
                                    </td>
                                    <td>100</td>
                                    <td>₹2,450.50</td>
                                    <td>₹2,525.75</td>
                                    <td class="text-success">+₹7,525</td>
                                    <td>
                                        <span class="performance-indicator performance-positive">
                                            +3.07%
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <strong>TCS</strong>
                                        <br><small class="text-muted">NSE</small>
                                    </td>
                                    <td>50</td>
                                    <td>₹3,620.00</td>
                                    <td>₹3,595.25</td>
                                    <td class="text-danger">-₹1,238</td>
                                    <td>
                                        <span class="performance-indicator performance-negative">
                                            -0.68%
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <strong>HDFC BANK</strong>
                                        <br><small class="text-muted">NSE</small>
                                    </td>
                                    <td>75</td>
                                    <td>₹1,580.30</td>
                                    <td>₹1,625.85</td>
                                    <td class="text-success">+₹3,416</td>
                                    <td>
                                        <span class="performance-indicator performance-positive">
                                            +2.88%
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline" id="recentActivity">
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="timeline-marker bg-success rounded-circle me-3" style="width: 12px; height: 12px; margin-top: 4px;"></div>
                                <div class="flex-grow-1">
                                    <small class="text-muted">2 hours ago</small>
                                    <p class="mb-1">Bought 50 shares of <strong>INFY</strong></p>
                                    <small class="text-success">₹1,750.25 each</small>
                                </div>
                            </div>
                        </div>
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="timeline-marker bg-danger rounded-circle me-3" style="width: 12px; height: 12px; margin-top: 4px;"></div>
                                <div class="flex-grow-1">
                                    <small class="text-muted">5 hours ago</small>
                                    <p class="mb-1">Sold 25 shares of <strong>WIPRO</strong></p>
                                    <small class="text-danger">₹425.50 each</small>
                                </div>
                            </div>
                        </div>
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="timeline-marker bg-info rounded-circle me-3" style="width: 12px; height: 12px; margin-top: 4px;"></div>
                                <div class="flex-grow-1">
                                    <small class="text-muted">1 day ago</small>
                                    <p class="mb-1">Dividend received from <strong>ITC</strong></p>
                                    <small class="text-info">₹2,350.00</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <a href="{{ url_for('kotak_api.orders') }}" class="btn btn-sm btn-outline-primary">
                            View All Orders
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Status -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Account Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Account Details:</h6>
                            <ul class="list-unstyled">
                                <li><strong>User Client Code:</strong> {{ ucc or 'Not provided' }}</li>
                                <li><strong>Mobile Number:</strong> {{ mobile or 'Not provided' }}</li>
                                <li><strong>Status:</strong> <span class="badge bg-success">Active</span></li>
                                <li><strong>Connection:</strong> <span class="text-success">Connected</span></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Quick Links:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-arrow-right me-2"></i><a href="{{ url_for('kotak_api.orders') }}">Place new orders</a></li>
                                <li><i class="fas fa-arrow-right me-2"></i><a href="{{ url_for('kotak_api.positions') }}">Monitor live positions</a></li>
                                <li><i class="fas fa-arrow-right me-2"></i><a href="{{ url_for('kotak_api.holdings') }}">View portfolio performance</a></li>
                                <li><i class="fas fa-arrow-right me-2"></i><a href="{{ url_for('kotak_api.logout') }}" class="text-danger">Logout from Kotak Neo</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Default Portfolio Content (Login Required) -->
<div class="container-fluid">
    <div class="row justify-content-center align-items-center min-vh-100">
        <div class="col-md-6 text-center">
            <div class="card">
                <div class="card-body p-4">
                    <h3 class="text-muted mb-3">Portfolio Access Required</h3>
                    <p class="text-muted mb-4">Please login to view your portfolio data.</p>
                    <a href="/trading-account/login" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt me-2"></i>Login
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Set portfolio nav link as active
    const portfolioLink = document.querySelector('a[href*="portfolio"]');
    if (portfolioLink) {
        document.querySelectorAll(".nav-link").forEach((link) => {
            link.classList.remove("active");
        });
        portfolioLink.classList.add("active");
    }

    // Initialize portfolio chart
    initializePortfolioChart();
    
    // Auto-refresh functionality
    setInterval(refreshPortfolioData, 30000);
    
    // Initial data load
    refreshPortfolioData();
});

function initializePortfolioChart() {
    const ctx = document.getElementById('portfolioChart');
    if (!ctx) return;

    // Sample data for portfolio performance
    const chartData = {
        labels: ['9:15', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '15:30'],
        datasets: [{
            label: 'Portfolio Value',
            data: [500000, 502500, 498000, 505000, 507500, 503000, 510000, 512000],
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }]
    };

    new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#adb5bd'
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#adb5bd',
                        callback: function(value) {
                            return '₹' + (value / 1000) + 'K';
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

function refreshPortfolioData() {
    // Update last refresh time
    document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString();
    
    // Simulate real-time data updates
    updateMetrics();
}

function updateMetrics() {
    // Sample data updates - replace with actual API calls
    const portfolioValue = document.getElementById('portfolioValue');
    const portfolioChange = document.getElementById('portfolioChange');
    const todayPnl = document.getElementById('todayPnl');
    const todayPnlPercent = document.getElementById('todayPnlPercent');
    const availableMargin = document.getElementById('availableMargin');
    const activePositions = document.getElementById('activePositions');

    if (portfolioValue) portfolioValue.textContent = '₹5,12,450.75';
    if (portfolioChange) portfolioChange.textContent = '+₹12,450.75 (+2.49%)';
    if (todayPnl) todayPnl.textContent = '₹8,250.50';
    if (todayPnlPercent) todayPnlPercent.textContent = '+1.64%';
    if (availableMargin) availableMargin.textContent = '₹2,45,000.00';
    if (activePositions) activePositions.textContent = '12';
}

function refreshPortfolio() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
    button.disabled = true;
    
    // Simulate API call
    setTimeout(() => {
        refreshPortfolioData();
        button.innerHTML = originalText;
        button.disabled = false;
        
        // Show success message
        if (typeof showToaster === 'function') {
            showToaster('Portfolio Updated', 'Your portfolio data has been refreshed successfully', 'success');
        }
    }, 2000);
}

function addToWatchlist() {
    const symbol = prompt('Enter symbol to add to watchlist:');
    if (symbol) {
        // Add to watchlist logic here
        if (typeof showToaster === 'function') {
            showToaster('Watchlist Updated', `${symbol} has been added to your watchlist`, 'success');
        }
    }
}

// Chart period selection
document.querySelectorAll('[data-period]').forEach(button => {
    button.addEventListener('click', function() {
        document.querySelectorAll('[data-period]').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        
        // Update chart with new period data
        const period = this.getAttribute('data-period');
        console.log('Loading data for period:', period);
        // Implement period-based data loading here
    });
});
</script>
{% endblock %}
