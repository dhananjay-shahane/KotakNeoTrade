{% extends "base.html" %}

{% block title %}Live Positions - Kotak Neo Trading{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/positions.css') }}"/>
<link rel="stylesheet" href="{{ url_for('static', filename='css/skeleton_animation.css') }}"/>
<style>
.gradient-bg {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.glass-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.stat-card {
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    border-radius: 24px;
    overflow: hidden;
    position: relative;
}

.stat-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: translateX(-100%);
    transition: transform 0.6s;
}

.stat-card:hover::before {
    transform: translateX(100%);
}

.stat-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
}

.metric-icon {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.modern-table {
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modern-table thead {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
}

.modern-table tbody tr {
    transition: all 0.3s ease;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.modern-table tbody tr:hover {
    background: linear-gradient(90deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    transform: scale(1.01);
}

.position-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.75rem;
}

.action-btn {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    border: none;
    margin: 0 2px;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

.floating-refresh {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 1000;
}

.floating-refresh:hover {
    transform: scale(1.1) rotate(180deg);
    box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
}

.skeleton-shimmer {
    background: linear-gradient(90deg, #374151 25%, #4B5563 50%, #374151 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.filter-chips {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.filter-chip {
    padding: 12px 24px;
    border-radius: 30px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.05);
    color: rgba(255, 255, 255, 0.8);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.filter-chip:hover, .filter-chip.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-title {
    font-size: 3.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 16px;
}

.page-subtitle {
    font-size: 1.2rem;
    color: rgba(255, 255, 255, 0.7);
    max-width: 600px;
    margin: 0 auto;
}

@media (max-width: 768px) {
    .page-title {
        font-size: 2.5rem;
    }

    .stat-card {
        margin-bottom: 20px;
    }

    .filter-chips {
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="min-vh-100" style="background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);">
    <!-- Loading Skeleton -->
    <div id="loadingSkeleton" style="display: none;" class="container py-5">
        <div class="page-header">
            <div class="skeleton-shimmer" style="height: 60px; width: 300px; margin: 0 auto 20px; border-radius: 10px;"></div>
            <div class="skeleton-shimmer" style="height: 20px; width: 500px; margin: 0 auto; border-radius: 10px;"></div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-xl-3 col-md-6">
                <div class="glass-card p-4" style="height: 160px;">
                    <div class="skeleton-shimmer" style="height: 20px; width: 120px; margin-bottom: 16px; border-radius: 10px;"></div>
                    <div class="skeleton-shimmer" style="height: 40px; width: 80px; border-radius: 10px;"></div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="glass-card p-4" style="height: 160px;">
                    <div class="skeleton-shimmer" style="height: 20px; width: 120px; margin-bottom: 16px; border-radius: 10px;"></div>
                    <div class="skeleton-shimmer" style="height: 40px; width: 80px; border-radius: 10px;"></div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="glass-card p-4" style="height: 160px;">
                    <div class="skeleton-shimmer" style="height: 20px; width: 120px; margin-bottom: 16px; border-radius: 10px;"></div>
                    <div class="skeleton-shimmer" style="height: 40px; width: 80px; border-radius: 10px;"></div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="glass-card p-4" style="height: 160px;">
                    <div class="skeleton-shimmer" style="height: 20px; width: 120px; margin-bottom: 16px; border-radius: 10px;"></div>
                    <div class="skeleton-shimmer" style="height: 40px; width: 80px; border-radius: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="container py-5">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Live Positions</h1>
            <p class="page-subtitle">Real-time portfolio tracking with advanced analytics and instant updates</p>
        </div>

        <!-- Statistics Cards -->
        <div class="row g-4 mb-5">
            <!-- Total Positions Card -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card glass-card p-4 h-100">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="metric-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <i class="fas fa-chart-pie text-white"></i>
                            </div>
                        </div>
                        <div class="text-end">
                            <h3 class="text-white mb-1 fw-bold" id="totalPositionsCount">0</h3>
                            <p class="text-white-50 mb-0">Total Positions</p>
                            <small class="text-success" style="font-size: 0.75rem;">
                                <i class="fas fa-arrow-up me-1"></i>Active
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Long Positions Card -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card glass-card p-4 h-100">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="metric-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                                <i class="fas fa-arrow-trend-up text-white"></i>
                            </div>
                        </div>
                        <div class="text-end">
                            <h3 class="text-success mb-1 fw-bold" id="longPositionsValue">₹0.00</h3>
                            <p class="text-white-50 mb-0">Long Positions</p>
                            <small class="text-white-50" style="font-size: 0.75rem;" id="longPositionsCount">0 positions</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Short Positions Card -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card glass-card p-4 h-100">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="metric-icon" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);">
                                <i class="fas fa-arrow-trend-down text-white"></i>
                            </div>
                        </div>
                        <div class="text-end">
                            <h3 class="text-danger mb-1 fw-bold" id="shortPositionsValue">₹0.00</h3>
                            <p class="text-white-50 mb-0">Short Positions</p>
                            <small class="text-white-50" style="font-size: 0.75rem;" id="shortPositionsCount">0 positions</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- P&L Card -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card glass-card p-4 h-100">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="metric-icon" style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);">
                                <i class="fas fa-calculator text-white"></i>
                            </div>
                        </div>
                        <div class="text-end">
                            <h3 class="text-warning mb-1 fw-bold" id="totalPnlValue">₹0.00</h3>
                            <p class="text-white-50 mb-0">Total P&L</p>
                            <small class="badge" style="font-size: 0.65rem;" id="pnlBadge">0%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="glass-card p-4 mb-4">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                <div class="filter-chips">
                    <div class="filter-chip active" onclick="filterPositionsByType('ALL')" id="filterAll">
                        <i class="fas fa-list me-2"></i>All Positions
                    </div>
                    <div class="filter-chip" onclick="filterPositionsByType('LONG')" id="filterLong">
                        <i class="fas fa-arrow-up me-2"></i>Long Only
                    </div>
                    <div class="filter-chip" onclick="filterPositionsByType('SHORT')" id="filterShort">
                        <i class="fas fa-arrow-down me-2"></i>Short Only
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle px-3 py-2" type="button" data-bs-toggle="dropdown" style="border-radius: 12px;">
                            <i class="fas fa-clock me-2"></i>Auto: <span id="refreshInterval">30s</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark">
                            <li><a class="dropdown-item" href="#" onclick="setAutoRefresh(10)">10 seconds</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setAutoRefresh(30)">30 seconds</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setAutoRefresh(60)">1 minute</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setAutoRefresh(0)">Disable</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Positions Table -->
        <div class="modern-table glass-card">
            <div class="table-responsive">
                <table class="table table-dark mb-0" id="positionsTable">
                    <thead>
                        <tr>
                            <th class="px-4 py-3 sortable-header" onclick="sortTable('symbol')" style="cursor: pointer;">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-tag me-2"></i>
                                    SYMBOL
                                    <i class="fas fa-sort ms-2 sort-icon" id="sort-symbol"></i>
                                </div>
                            </th>
                            <th class="px-4 py-3 sortable-header" onclick="sortTable('product')" style="cursor: pointer;">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-cube me-2"></i>
                                    PRODUCT
                                    <i class="fas fa-sort ms-2 sort-icon" id="sort-product"></i>
                                </div>
                            </th>
                            <th class="px-4 py-3 sortable-header" onclick="sortTable('netQty')" style="cursor: pointer;">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-balance-scale me-2"></i>
                                    NET QTY
                                    <i class="fas fa-sort ms-2 sort-icon" id="sort-netQty"></i>
                                </div>
                            </th>
                            <th class="px-4 py-3 sortable-header" onclick="sortTable('buyAmt')" style="cursor: pointer;">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-arrow-up me-2 text-success"></i>
                                    BUY AMOUNT
                                    <i class="fas fa-sort ms-2 sort-icon" id="sort-buyAmt"></i>
                                </div>
                            </th>
                            <th class="px-4 py-3 sortable-header" onclick="sortTable('sellAmt')" style="cursor: pointer;">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-arrow-down me-2 text-danger"></i>
                                    SELL AMOUNT
                                    <i class="fas fa-sort ms-2 sort-icon" id="sort-sellAmt"></i>
                                </div>
                            </th>
                            <th class="px-4 py-3 sortable-header" onclick="sortTable('pnl')" style="cursor: pointer;">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-chart-line me-2"></i>
                                    P&L
                                    <i class="fas fa-sort ms-2 sort-icon" id="sort-pnl"></i>
                                </div>
                            </th>
                            <th class="px-4 py-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-flag me-2"></i>
                                    POSITION
                                </div>
                            </th>
                            <th class="px-4 py-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-cogs me-2"></i>
                                    ACTIONS
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="positionsTableBody">
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <div class="d-flex flex-column align-items-center">
                                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <h5 class="text-white-50 mb-2">Loading Positions</h5>
                                    <p class="text-white-50 mb-0">Fetching your latest portfolio data...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Position Count Badge -->
        <div class="text-center mt-4">
            <span class="badge bg-primary px-4 py-2" style="border-radius: 20px; font-size: 0.9rem;">
                <i class="fas fa-list me-2"></i>
                Showing <span id="positionsTableCount">0</span> positions
            </span>
        </div>
    </div>

    <!-- Floating Refresh Button -->
    <button class="floating-refresh" onclick="refreshPositions()" title="Refresh Positions">
        <i class="fas fa-sync-alt"></i>
    </button>

    <!-- Enhanced Position Details Modal -->
    <div class="modal fade" id="positionDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title text-white fw-bold">
                        <i class="fas fa-info-circle me-2 text-primary"></i>Position Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Symbol Header -->
                    <div class="text-center mb-4 p-4" style="background: rgba(255,255,255,0.05); border-radius: 16px;">
                        <h2 class="text-primary mb-2 fw-bold" id="detailTradingSymbol">-</h2>
                        <div class="d-flex justify-content-center gap-2 flex-wrap">
                            <span class="badge bg-info px-3 py-2" id="detailExchange">-</span>
                            <span class="badge bg-warning px-3 py-2" id="detailProduct">-</span>
                            <span class="badge px-3 py-2" id="detailPositionType">-</span>
                        </div>
                    </div>

                    <!-- Quantity Summary -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="text-center p-3" style="background: rgba(40, 167, 69, 0.1); border-radius: 12px; border: 1px solid rgba(40, 167, 69, 0.3);">
                                <div class="text-success fs-4 fw-bold" id="detailBuyQty">0</div>
                                <small class="text-white-50">Buy Quantity</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3" style="background: rgba(220, 53, 69, 0.1); border-radius: 12px; border: 1px solid rgba(220, 53, 69, 0.3);">
                                <div class="text-danger fs-4 fw-bold" id="detailSellQty">0</div>
                                <small class="text-white-50">Sell Quantity</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3" style="background: rgba(102, 126, 234, 0.1); border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.3);">
                                <div class="text-primary fs-4 fw-bold" id="detailNetQty">0</div>
                                <small class="text-white-50">Net Quantity</small>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Summary -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 12px;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-white-50">Buy Amount</span>
                                    <span class="text-success fw-bold" id="detailBuyAmt">₹0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 12px;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-white-50">Sell Amount</span>
                                    <span class="text-danger fw-bold" id="detailSellAmt">₹0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- P&L Highlight -->
                    <div class="text-center p-4 mb-4" style="background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                        <h3 class="fw-bold mb-1" id="detailPnl">₹0.00</h3>
                        <p class="text-white-50 mb-0">Profit & Loss</p>
                    </div>

                    <!-- Additional Info -->
                    <div class="row g-3 small">
                        <div class="col-md-6">
                            <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 12px;">
                                <div class="d-flex justify-content-between">
                                    <span class="text-white-50">Current Price</span>
                                    <span class="text-info fw-bold" id="detailCurrentPrice">₹0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 12px;">
                                <div class="d-flex justify-content-between">
                                    <span class="text-white-50">Expiry</span>
                                    <span class="text-white" id="detailExpiry">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-light px-4" data-bs-dismiss="modal" style="border-radius: 12px;">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/skeleton_animation.js') }}"></script>
<script src="{{ url_for('static', filename='js/positions.js') }}"></script>
{% endblock %}