{% extends "base.html" %}

{% block title %}Kotak Neo - Orders{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h4 class="page-title">
                    <i class="fas fa-list-alt me-2"></i>
                    Orders
                </h4>
                <div class="page-breadcrumb">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('portfolio') }}">Portfolio</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('kotak_api.dashboard') }}">Kotak Neo</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Orders</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Order Book
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-primary me-2" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        Loading orders...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadOrders();
});

async function loadOrders() {
    try {
        const response = await fetch('/kotak/api/orders');
        const data = await response.json();
        
        const tbody = document.getElementById('ordersTableBody');
        
        if (data.orders && data.orders.length > 0) {
            tbody.innerHTML = data.orders.map(order => `
                <tr>
                    <td>${order.order_id}</td>
                    <td>${order.symbol}</td>
                    <td>
                        <span class="badge bg-${order.side === 'BUY' ? 'success' : 'danger'}">
                            ${order.side}
                        </span>
                    </td>
                    <td>${order.quantity}</td>
                    <td>â‚¹${order.price}</td>
                    <td>
                        <span class="badge bg-${getStatusBadge(order.status)}">
                            ${order.status}
                        </span>
                    </td>
                    <td>${formatDateTime(order.timestamp)}</td>
                    <td>
                        ${order.status === 'PENDING' ? 
                            `<button class="btn btn-sm btn-outline-danger" onclick="cancelOrder('${order.order_id}')">
                                Cancel
                            </button>` : 
                            '-'
                        }
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No orders found</p>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('ordersTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                    <p class="text-muted">Error loading orders</p>
                </td>
            </tr>
        `;
    }
}

function getStatusBadge(status) {
    const statusMap = {
        'PENDING': 'warning',
        'COMPLETED': 'success',
        'CANCELLED': 'danger',
        'REJECTED': 'danger'
    };
    return statusMap[status] || 'secondary';
}

function formatDateTime(timestamp) {
    return new Date(timestamp).toLocaleString();
}

async function cancelOrder(orderId) {
    try {
        const response = await fetch(`/kotak/api/orders/${orderId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Order Cancelled',
                text: 'Order has been cancelled successfully',
                timer: 2000,
                showConfirmButton: false
            });
            loadOrders(); // Reload orders
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Cancel Failed',
                text: data.error || 'Failed to cancel order'
            });
        }
    } catch (error) {
        console.error('Error cancelling order:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to cancel order'
        });
    }
}
</script>
{% endblock %}