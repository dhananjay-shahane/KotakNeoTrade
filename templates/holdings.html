{% extends "base.html" %}

{% block title %}Holdings - Kotak Neo Trading{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/skeleton_animation.css') }}">
<style>
.skeleton-shimmer {
    background: linear-gradient(90deg, #374151 25%, #4B5563 50%, #374151 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.skeleton-card {
    height: 60px;
    border-radius: 8px;
}

.skeleton-text {
    background: linear-gradient(90deg, #374151 25%, #4B5563 50%, #374151 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}

.skeleton-table-row {
    height: 45px;
    margin-bottom: 8px;
    border-radius: 4px;
}

.sortable-header {
    cursor: pointer;
    position: relative;
    user-select: none;
    transition: background-color 0.2s;
}

.sortable-header:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.sort-icon {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0.5;
    transition: opacity 0.2s;
}

.sortable-header:hover .sort-icon {
    opacity: 1;
}

.sort-icon.active {
    opacity: 1;
    color: #17a2b8 !important;
}

.filter-controls {
    background: #374151;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 16px;
}

.filter-button {
    transition: all 0.2s;
}

.filter-button.active {
    background-color: #17a2b8 !important;
    border-color: #17a2b8 !important;
}

.card-gradient-1 {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.card-gradient-2 {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.card-gradient-3 {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.card-gradient-positive {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.card-gradient-negative {
    background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
}

.enhanced-card {
    transition: all 0.3s ease;
    border-radius: 12px !important;
}

.enhanced-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3) !important;
}
</style>
{% endblock %}

{% block content %}
<!-- Loading Skeleton (Hidden by default) -->
<div id="loadingSkeleton" style="display: none;">
    <div class="row mb-2">
        <div class="col">
            <h4 class="mb-1">Portfolio Holdings</h4>
            <small class="text-muted">Loading portfolio data...</small>
        </div>
    </div>
    
    <!-- Skeleton Summary Cards -->
    <div class="row mb-3">
        <div class="col-lg-3 col-md-6 mb-2">
            <div class="card bg-secondary border-0" style="height: 80px;">
                <div class="card-body p-3">
                    <div class="skeleton-shimmer skeleton-text mb-1" style="height: 12px; width: 60%; border-radius: 4px;"></div>
                    <div class="skeleton-shimmer skeleton-text" style="height: 24px; width: 40%; border-radius: 4px;"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-2">
            <div class="card bg-secondary border-0" style="height: 80px;">
                <div class="card-body p-3">
                    <div class="skeleton-shimmer skeleton-text mb-1" style="height: 12px; width: 50%; border-radius: 4px;"></div>
                    <div class="skeleton-shimmer skeleton-text" style="height: 24px; width: 70%; border-radius: 4px;"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-2">
            <div class="card bg-secondary border-0" style="height: 80px;">
                <div class="card-body p-3">
                    <div class="skeleton-shimmer skeleton-text mb-1" style="height: 12px; width: 65%; border-radius: 4px;"></div>
                    <div class="skeleton-shimmer skeleton-text" style="height: 24px; width: 75%; border-radius: 4px;"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-2">
            <div class="card bg-secondary border-0" style="height: 80px;">
                <div class="card-body p-3">
                    <div class="skeleton-shimmer skeleton-text mb-1" style="height: 12px; width: 45%; border-radius: 4px;"></div>
                    <div class="skeleton-shimmer skeleton-text" style="height: 24px; width: 60%; border-radius: 4px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Skeleton Filter Controls -->
    <div class="card bg-secondary border-0 mb-3" style="border-radius: 8px;">
        <div class="card-body p-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex gap-2">
                        <div class="skeleton-shimmer skeleton-text" style="height: 32px; width: 80px; border-radius: 4px;"></div>
                        <div class="skeleton-shimmer skeleton-text" style="height: 32px; width: 75px; border-radius: 4px;"></div>
                        <div class="skeleton-shimmer skeleton-text" style="height: 32px; width: 60px; border-radius: 4px;"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-2 justify-content-md-end">
                        <div class="skeleton-shimmer skeleton-text" style="height: 32px; width: 150px; border-radius: 4px;"></div>
                        <div class="skeleton-shimmer skeleton-text" style="height: 32px; width: 70px; border-radius: 4px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skeleton Table -->
    <div class="card bg-secondary border-0">
        <div class="card-header bg-dark py-2">
            <div class="skeleton-shimmer skeleton-text" style="height: 16px; width: 120px; border-radius: 4px;"></div>
        </div>
        <div class="card-body p-3">
            <div class="skeleton-shimmer skeleton-table-row mb-2"></div>
            <div class="skeleton-shimmer skeleton-table-row mb-2"></div>
            <div class="skeleton-shimmer skeleton-table-row mb-2"></div>
            <div class="skeleton-shimmer skeleton-table-row mb-2"></div>
            <div class="skeleton-shimmer skeleton-table-row mb-2"></div>
            <div class="skeleton-shimmer skeleton-table-row"></div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div id="mainContent">
    <div class="row mb-2">
        <div class="col">
            <h4 class="mb-1">Portfolio Holdings</h4>
            <small class="text-muted">Long-term investment portfolio overview</small>
        </div>
        <div class="col-auto">
            <button class="btn btn-sm btn-primary" onclick="refreshHoldings()">
                <i class="fas fa-sync me-1"></i>Refresh
            </button>
        </div>
    </div>

    {% if holdings %}
    <!-- Calculate totals for cards -->
    {% set total_invested = 0.0 %}
    {% set total_current = 0.0 %}
    {% for holding in holdings %}
        {% if holding.holdingCost %}
            {% set invested = holding.holdingCost|float %}
            {% set total_invested = total_invested + invested %}
        {% endif %}
        {% if holding.mktValue %}
            {% set current = holding.mktValue|float %}
            {% set total_current = total_current + current %}
        {% endif %}
    {% endfor %}
    {% set total_pnl = total_current - total_invested %}
    {% set pnl_percentage = (total_pnl / total_invested * 100) if total_invested > 0 else 0 %}

    <!-- Enhanced Summary Cards -->
    <div class="row mb-3">
        <div class="col-lg-3 col-md-6 mb-2">
            <div class="card enhanced-card border-0 shadow-sm card-gradient-1" style="height: 80px;">
                <div class="card-body p-3 d-flex align-items-center justify-content-between">
                    <div>
                        <small class="text-white-50 d-block fw-medium">Holdings</small>
                        <div class="fw-bold text-white fs-4" id="holdingsCount">{{ holdings|length if holdings else 0 }}</div>
                    </div>
                    <div class="text-white opacity-75">
                        <i class="fas fa-briefcase fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-2">
            <div class="card enhanced-card border-0 shadow-sm card-gradient-2" style="height: 80px;">
                <div class="card-body p-3 d-flex align-items-center justify-content-between">
                    <div>
                        <small class="text-white-50 d-block fw-medium">Invested</small>
                        <div class="fw-bold text-white fs-6" id="totalInvestedValue">₹{{ "{:,.0f}".format(total_invested) }}</div>
                    </div>
                    <div class="text-white opacity-75">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-2">
            <div class="card enhanced-card border-0 shadow-sm card-gradient-3" style="height: 80px;">
                <div class="card-body p-3 d-flex align-items-center justify-content-between">
                    <div>
                        <small class="text-white-50 d-block fw-medium">Current Value</small>
                        <div class="fw-bold text-white fs-6" id="totalHoldingsValue">₹{{ "{:,.0f}".format(total_current) }}</div>
                    </div>
                    <div class="text-white opacity-75">
                        <i class="fas fa-coins fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-2">
            <div class="card enhanced-card border-0 shadow-sm {% if total_pnl >= 0 %}card-gradient-positive{% else %}card-gradient-negative{% endif %}" style="height: 80px;">
                <div class="card-body p-3 d-flex align-items-center justify-content-between">
                    <div>
                        <small class="text-white-50 d-block fw-medium">Total P&L</small>
                        <div class="fw-bold text-white fs-6" id="totalHoldingsPnl">
                            {% if total_pnl > 0 %}+{% endif %}₹{{ "{:,.0f}".format(total_pnl) }}
                        </div>
                        <small class="text-white-50" id="totalHoldingsPnlPercentage">
                            ({% if total_pnl > 0 %}+{% endif %}{{ "{:.1f}".format(pnl_percentage) }}%)
                        </small>
                    </div>
                    <div class="text-white opacity-75">
                        <i class="fas fa-{% if total_pnl >= 0 %}arrow-trend-up{% else %}arrow-trend-down{% endif %} fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and Sort Controls -->
    <div class="filter-controls">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-sm btn-outline-light filter-button active" onclick="filterHoldings('all')" id="filterAll">
                        All Holdings
                    </button>
                    <button class="btn btn-sm btn-outline-light filter-button" onclick="filterHoldings('profitable')" id="filterProfitable">
                        Profitable
                    </button>
                    <button class="btn btn-sm btn-outline-light filter-button" onclick="filterHoldings('loss')" id="filterLoss">
                        In Loss
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex gap-2 justify-content-md-end">
                    <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary" 
                           placeholder="Search symbols..." id="searchInput" onkeyup="searchHoldings()" style="max-width: 200px;">
                    <button class="btn btn-sm btn-outline-light" onclick="resetFilters()">
                        <i class="fas fa-undo me-1"></i>Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Holdings Table -->
    <div class="card bg-secondary border-0">
        <div class="card-header bg-dark d-flex justify-content-between align-items-center py-2">
            <small class="mb-0 text-white fw-bold">Holdings Details</small>
            <div class="d-flex gap-1">
                <span class="badge bg-info" id="visibleHoldingsCount">{{ holdings|length if holdings else 0 }} holdings</span>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0 table-sm" id="holdingsTable">
                    <thead class="bg-dark">
                        <tr style="font-size: 0.85rem;">
                            <th class="sortable-header border-0 py-3" onclick="sortTable('symbol')" data-sort="symbol">
                                SYMBOL
                                <i class="fas fa-sort sort-icon" id="sort-symbol"></i>
                            </th>
                            <th class="sortable-header border-0 py-3" onclick="sortTable('exchange')" data-sort="exchange">
                                EXCHANGE
                                <i class="fas fa-sort sort-icon" id="sort-exchange"></i>
                            </th>
                            <th class="sortable-header border-0 py-3" onclick="sortTable('quantity')" data-sort="quantity">
                                QTY
                                <i class="fas fa-sort sort-icon" id="sort-quantity"></i>
                            </th>
                            <th class="sortable-header border-0 py-3" onclick="sortTable('avgPrice')" data-sort="avgPrice">
                                AVG PRICE
                                <i class="fas fa-sort sort-icon" id="sort-avgPrice"></i>
                            </th>
                            <th class="sortable-header border-0 py-3" onclick="sortTable('ltp')" data-sort="ltp">
                                LTP
                                <i class="fas fa-sort sort-icon" id="sort-ltp"></i>
                            </th>
                            <th class="sortable-header border-0 py-3" onclick="sortTable('marketValue')" data-sort="marketValue">
                                MARKET VALUE
                                <i class="fas fa-sort sort-icon" id="sort-marketValue"></i>
                            </th>
                            <th class="sortable-header border-0 py-3" onclick="sortTable('pnl')" data-sort="pnl">
                                P&L
                                <i class="fas fa-sort sort-icon" id="sort-pnl"></i>
                            </th>
                            <th class="sortable-header border-0 py-3" onclick="sortTable('dayChange')" data-sort="dayChange">
                                DAY CHANGE
                                <i class="fas fa-sort sort-icon" id="sort-dayChange"></i>
                            </th>
                            <th class="border-0 py-3">ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsTableBody">
                        {% for holding in holdings %}
                        {% set invested_value = holding.holdingCost|float if holding.holdingCost else 0.0 %}
                        {% set market_value = holding.mktValue|float if holding.mktValue else 0.0 %}
                        {% set pnl = market_value - invested_value %}
                        {% set avg_price = holding.averagePrice|float if holding.averagePrice else 0.0 %}
                        {% set ltp = holding.closingPrice|float if holding.closingPrice else 0.0 %}
                        {% set day_change_pct = ((ltp - avg_price) / avg_price * 100) if avg_price > 0 else 0 %}

                        <tr class="border-0" 
                            data-symbol="{{ holding.displaySymbol or holding.symbol or 'N/A' }}"
                            data-exchange="{{ holding.exchangeSegment or 'N/A' }}"
                            data-quantity="{{ holding.quantity or 0 }}"
                            data-avg-price="{{ avg_price }}"
                            data-ltp="{{ ltp }}"
                            data-market-value="{{ market_value }}"
                            data-pnl="{{ pnl }}"
                            data-day-change="{{ day_change_pct }}">

                            <td class="border-0 py-2">
                                <div>
                                    <strong class="text-white">{{ holding.displaySymbol or holding.symbol or 'N/A' }}</strong>
                                    {% if holding.instrumentName %}
                                        <br><small class="text-muted">{{ holding.instrumentName[:25] }}...</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="border-0 py-2">
                                <span class="badge bg-info">{{ holding.exchangeSegment or 'N/A' }}</span>
                            </td>
                            <td class="border-0 py-2 text-info fw-semibold">
                                {{ holding.quantity or '0' }}
                            </td>
                            <td class="border-0 py-2 text-light">₹{{ "{:,.2f}".format(avg_price) }}</td>
                            <td class="border-0 py-2 text-warning fw-semibold">₹{{ "{:,.2f}".format(ltp) }}</td>
                            <td class="border-0 py-2 text-info fw-semibold">
                                ₹{{ "{:,.2f}".format(market_value) }}
                            </td>
                            <td class="border-0 py-2">
                                <span class="fw-bold {% if pnl > 0 %}text-success{% elif pnl < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if pnl > 0 %}+{% endif %}₹{{ "{:,.2f}".format(pnl) }}
                                    {% if invested_value > 0 %}
                                        <br><small class="{% if pnl > 0 %}text-success{% elif pnl < 0 %}text-danger{% else %}text-muted{% endif %}">
                                            ({% if pnl > 0 %}+{% endif %}{{ "{:.2f}".format((pnl/invested_value)*100) }}%)
                                        </small>
                                    {% endif %}
                                </span>
                            </td>
                            <td class="border-0 py-2">
                                <span class="fw-bold {% if day_change_pct > 0 %}text-success{% elif day_change_pct < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if day_change_pct > 0 %}+{% endif %}{{ "{:.2f}".format(day_change_pct) }}%
                                </span>
                            </td>
                            <td class="border-0 py-2">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-success me-1" onclick="openHoldingAction('{{ holding.displaySymbol or holding.symbol }}', 'sell', {{ ltp }}, {{ holding.quantity }})">
                                        <i class="fas fa-minus me-1"></i>Sell
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="openHoldingAction('{{ holding.displaySymbol or holding.symbol }}', 'buy', {{ ltp }}, 0)">
                                        <i class="fas fa-plus me-1"></i>Buy
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% else %}
    <div class="card bg-secondary">
        <div class="card-body text-center py-4">
            <h5 class="text-muted">No Holdings Found</h5>
            <p class="text-muted">You don't have any holdings in your portfolio.</p>
            <a href="{{ url_for('show_dashboard') }}" class="btn btn-primary">Start Investing</a>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Global variables for sorting and filtering
let currentSort = { column: '', direction: 'asc' };
let currentFilter = 'all';
let originalRows = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Show loading skeleton briefly
    showLoadingSkeleton();
    
    // Store original table rows for filtering/sorting
    const tableBody = document.getElementById('holdingsTableBody');
    if (tableBody) {
        originalRows = Array.from(tableBody.querySelectorAll('tr'));
    }
    
    // Hide skeleton after brief delay to show loading effect
    setTimeout(() => {
        hideLoadingSkeleton();
    }, 800);
});

function showLoadingSkeleton() {
    document.getElementById('loadingSkeleton').style.display = 'block';
    document.getElementById('mainContent').style.display = 'none';
}

function hideLoadingSkeleton() {
    document.getElementById('loadingSkeleton').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
}

function sortTable(column) {
    const tableBody = document.getElementById('holdingsTableBody');
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    
    // Determine sort direction
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }
    
    // Clear all sort icons
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.className = 'fas fa-sort sort-icon';
    });
    
    // Set active sort icon
    const sortIcon = document.getElementById(`sort-${column}`);
    if (sortIcon) {
        sortIcon.className = `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'} sort-icon active`;
    }
    
    // Sort rows
    rows.sort((a, b) => {
        let aValue, bValue;
        
        switch (column) {
            case 'symbol':
                aValue = a.dataset.symbol || '';
                bValue = b.dataset.symbol || '';
                break;
            case 'exchange':
                aValue = a.dataset.exchange || '';
                bValue = b.dataset.exchange || '';
                break;
            case 'quantity':
                aValue = parseFloat(a.dataset.quantity) || 0;
                bValue = parseFloat(b.dataset.quantity) || 0;
                break;
            case 'avgPrice':
                aValue = parseFloat(a.dataset.avgPrice) || 0;
                bValue = parseFloat(b.dataset.avgPrice) || 0;
                break;
            case 'ltp':
                aValue = parseFloat(a.dataset.ltp) || 0;
                bValue = parseFloat(b.dataset.ltp) || 0;
                break;
            case 'marketValue':
                aValue = parseFloat(a.dataset.marketValue) || 0;
                bValue = parseFloat(b.dataset.marketValue) || 0;
                break;
            case 'pnl':
                aValue = parseFloat(a.dataset.pnl) || 0;
                bValue = parseFloat(b.dataset.pnl) || 0;
                break;
            case 'dayChange':
                aValue = parseFloat(a.dataset.dayChange) || 0;
                bValue = parseFloat(b.dataset.dayChange) || 0;
                break;
            default:
                return 0;
        }
        
        if (typeof aValue === 'string') {
            return currentSort.direction === 'asc' 
                ? aValue.localeCompare(bValue)
                : bValue.localeCompare(aValue);
        } else {
            return currentSort.direction === 'asc' 
                ? aValue - bValue
                : bValue - aValue;
        }
    });
    
    // Re-append sorted rows
    rows.forEach(row => tableBody.appendChild(row));
    
    // Update visible count
    updateVisibleCount();
}

function filterHoldings(filterType) {
    currentFilter = filterType;
    
    // Update filter button states
    document.querySelectorAll('.filter-button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`filter${filterType.charAt(0).toUpperCase() + filterType.slice(1)}`).classList.add('active');
    
    const tableBody = document.getElementById('holdingsTableBody');
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    
    rows.forEach(row => {
        const pnl = parseFloat(row.dataset.pnl) || 0;
        let shouldShow = true;
        
        switch (filterType) {
            case 'profitable':
                shouldShow = pnl > 0;
                break;
            case 'loss':
                shouldShow = pnl < 0;
                break;
            case 'all':
            default:
                shouldShow = true;
                break;
        }
        
        row.style.display = shouldShow ? '' : 'none';
    });
    
    updateVisibleCount();
}

function searchHoldings() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const tableBody = document.getElementById('holdingsTableBody');
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    
    rows.forEach(row => {
        const symbol = (row.dataset.symbol || '').toLowerCase();
        const shouldShow = symbol.includes(searchTerm);
        
        // Apply both search and filter
        const pnl = parseFloat(row.dataset.pnl) || 0;
        let filterShow = true;
        
        switch (currentFilter) {
            case 'profitable':
                filterShow = pnl > 0;
                break;
            case 'loss':
                filterShow = pnl < 0;
                break;
        }
        
        row.style.display = (shouldShow && filterShow) ? '' : 'none';
    });
    
    updateVisibleCount();
}

function resetFilters() {
    // Reset search
    document.getElementById('searchInput').value = '';
    
    // Reset filter to 'all'
    filterHoldings('all');
    
    // Reset sort
    currentSort = { column: '', direction: 'asc' };
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.className = 'fas fa-sort sort-icon';
    });
    
    // Restore original order
    const tableBody = document.getElementById('holdingsTableBody');
    originalRows.forEach(row => tableBody.appendChild(row));
    
    updateVisibleCount();
}

function updateVisibleCount() {
    const visibleRows = document.querySelectorAll('#holdingsTableBody tr[style=""], #holdingsTableBody tr:not([style])');
    document.getElementById('visibleHoldingsCount').textContent = `${visibleRows.length} holdings`;
}

function openHoldingAction(symbol, action, price, maxQty) {
    // Implementation for trading modal would go here
    console.log(`${action} ${symbol} at ${price}, max qty: ${maxQty}`);
}

function refreshHoldings() {
    if (typeof loadHoldingsData === 'function') {
        showLoadingSkeleton();
        loadHoldingsData();
    } else {
        location.reload();
    }
}
</script>
{% endblock %}