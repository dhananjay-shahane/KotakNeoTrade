{% extends "base.html" %}

{% block title %}Kotak Neo - Positions{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h4 class="page-title">
                    <i class="fas fa-chart-bar me-2"></i>
                    Positions
                </h4>
                <div class="page-breadcrumb">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('portfolio') }}">Portfolio</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('kotak_api.dashboard') }}">Kotak Neo</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Positions</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Trading Positions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Quantity</th>
                                    <th>Avg Price</th>
                                    <th>LTP</th>
                                    <th>P&L</th>
                                    <th>P&L %</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="positionsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-primary me-2" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        Loading positions...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadPositions();
});

async function loadPositions() {
    try {
        const response = await fetch('/kotak/api/positions');
        const data = await response.json();
        
        const tbody = document.getElementById('positionsTableBody');
        
        if (data.positions && data.positions.length > 0) {
            tbody.innerHTML = data.positions.map(position => `
                <tr>
                    <td>
                        <strong>${position.symbol}</strong>
                        <br>
                        <small class="text-muted">${position.exchange}</small>
                    </td>
                    <td>${position.quantity}</td>
                    <td>₹${position.avg_price}</td>
                    <td>₹${position.ltp}</td>
                    <td class="text-${position.pnl >= 0 ? 'success' : 'danger'}">
                        ₹${position.pnl}
                    </td>
                    <td class="text-${position.pnl_percent >= 0 ? 'success' : 'danger'}">
                        ${position.pnl_percent}%
                    </td>
                    <td>
                        <span class="badge bg-${position.quantity > 0 ? 'success' : 'danger'}">
                            ${position.quantity > 0 ? 'LONG' : 'SHORT'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="squareOff('${position.symbol}')">
                            Square Off
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No positions found</p>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Error loading positions:', error);
        document.getElementById('positionsTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                    <p class="text-muted">Error loading positions</p>
                </td>
            </tr>
        `;
    }
}

async function squareOff(symbol) {
    try {
        const result = await Swal.fire({
            title: 'Square Off Position',
            text: `Are you sure you want to square off your position in ${symbol}?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Yes, square off',
            cancelButtonText: 'Cancel'
        });

        if (result.isConfirmed) {
            const response = await fetch(`/kotak/api/positions/${symbol}/square-off`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Position Squared Off',
                    text: 'Position has been squared off successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
                loadPositions(); // Reload positions
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Square Off Failed',
                    text: data.error || 'Failed to square off position'
                });
            }
        }
    } catch (error) {
        console.error('Error squaring off position:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to square off position'
        });
    }
}
</script>
{% endblock %}